<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>lopensemble • lopensemble</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="lopensemble">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lopensemble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/lopensemble.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>lopensemble</h1>
            
      

      <div class="hidden name"><code>lopensemble.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>lopensemble</code> package provides an easy way to combine
predictions from individual time series or panel data models to an
ensemble. <code>lopensemble</code> stacks Models according to the
Continuous Ranked Probability Score (CRPS) over k-step ahead
predictions. It is therefore especially suited for timeseries and panel
data. A function for leave-one-out CRPS may be added in the future.
Predictions need to be predictive distributions represented by
predictive samples. Usually, these will be sets of posterior predictive
simulation draws generated by an MCMC algorithm.</p>
<p>Given some training data with true observed values as well as
predictive samples generated from different models,
<code>crps_weights</code> finds the optimal (in the sense of minimizing
expected cross-validation predictive error) weights to form an ensemble
from these models. Using these weights,
<code>mixture_from_samples</code> can then provide samples from the
optimal model mixture by drawing from the predictice samples of the
individual models in the correct proportion. This gives a mixture model
solely based on predictive samples and is in this regard superior to
other ensembling techniques like Bayesian Model Averaging.</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>Here is an example of how to use <code>lopensemble</code> with a toy
data set. The data contains true observed values as well as predictive
samples generated by different models.</p>
<div class="section level4">
<h4 id="load-example-data-and-split-into-train-and-test-data">Load example data and split into train and test data<a class="anchor" aria-label="anchor" href="#load-example-data-and-split-into-train-and-test-data"></a>
</h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com" class="external-link">"data.table"</a></span><span class="op">)</span></span>
<span><span class="va">splitdate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-03-28"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;         geography  model sample_id       date predicted observed</span></span>
<span><span class="co">#&gt;            &lt;char&gt; &lt;char&gt;     &lt;num&gt;     &lt;Date&gt;     &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">#&gt;      1:  Tatooine  ARIMA         1 2020-03-14  1.719445 1.655068</span></span>
<span><span class="co">#&gt;      2:  Tatooine  ARIMA         2 2020-03-14  1.896555 1.655068</span></span>
<span><span class="co">#&gt;      3:  Tatooine  ARIMA         3 2020-03-14  1.766821 1.655068</span></span>
<span><span class="co">#&gt;      4:  Tatooine  ARIMA         4 2020-03-14  1.714007 1.655068</span></span>
<span><span class="co">#&gt;      5:  Tatooine  ARIMA         5 2020-03-14  1.726421 1.655068</span></span>
<span><span class="co">#&gt;     ---                                                         </span></span>
<span><span class="co">#&gt; 103996: Coruscant  Naive       496 2020-04-08  1.460421 1.543976</span></span>
<span><span class="co">#&gt; 103997: Coruscant  Naive       497 2020-04-08  1.057846 1.543976</span></span>
<span><span class="co">#&gt; 103998: Coruscant  Naive       498 2020-04-08  1.433936 1.543976</span></span>
<span><span class="co">#&gt; 103999: Coruscant  Naive       499 2020-04-08  1.719357 1.543976</span></span>
<span><span class="co">#&gt; 104000: Coruscant  Naive       500 2020-04-08  0.781818 1.543976</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">traindata</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">[</span><span class="va">date</span> <span class="op">&lt;=</span> <span class="va">splitdate</span><span class="op">]</span></span>
<span><span class="va">testdata</span> <span class="op">&lt;-</span> <span class="va">example_data</span><span class="op">[</span><span class="va">date</span> <span class="op">&gt;</span> <span class="va">splitdate</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="get-weights-and-create-mixture">Get weights and create mixture<a class="anchor" aria-label="anchor" href="#get-weights-and-create-mixture"></a>
</h4>
<p>Obtain weights based on trainin data, create mixture based on
predictive samples in the testing data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu">lopensemble</span><span class="fu">::</span><span class="fu"><a href="../reference/crps_weights.html">crps_weights</a></span><span class="op">(</span><span class="va">traindata</span><span class="op">)</span></span>
<span><span class="va">test_mixture</span> <span class="op">&lt;-</span> <span class="fu">lopensemble</span><span class="fu">::</span><span class="fu"><a href="../reference/mixture_from_samples.html">mixture_from_samples</a></span><span class="op">(</span><span class="va">testdata</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">test_mixture</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;geography, sample_id, date, observed&gt;</span></span>
<span><span class="co">#&gt;        geography sample_id       date  observed predicted        model</span></span>
<span><span class="co">#&gt;           &lt;char&gt;     &lt;num&gt;     &lt;Date&gt;     &lt;num&gt;     &lt;num&gt;       &lt;char&gt;</span></span>
<span><span class="co">#&gt;     1: Coruscant         1 2020-03-29 1.5002089 1.6056708 CRPS_Mixture</span></span>
<span><span class="co">#&gt;     2: Coruscant         1 2020-03-30 1.4713551 1.8436852 CRPS_Mixture</span></span>
<span><span class="co">#&gt;     3: Coruscant         1 2020-03-31 1.4154616 1.2926579 CRPS_Mixture</span></span>
<span><span class="co">#&gt;     4: Coruscant         1 2020-04-01 1.3426560 0.4212479 CRPS_Mixture</span></span>
<span><span class="co">#&gt;     5: Coruscant         1 2020-04-02 1.3298251 1.3518078 CRPS_Mixture</span></span>
<span><span class="co">#&gt;    ---                                                                </span></span>
<span><span class="co">#&gt; 10996:  Tatooine       500 2020-04-04 0.6750499 0.6838004 CRPS_Mixture</span></span>
<span><span class="co">#&gt; 10997:  Tatooine       500 2020-04-05 0.7225369 0.4405134 CRPS_Mixture</span></span>
<span><span class="co">#&gt; 10998:  Tatooine       500 2020-04-06 0.7532836 0.4858075 CRPS_Mixture</span></span>
<span><span class="co">#&gt; 10999:  Tatooine       500 2020-04-07 0.7598158 0.9897033 CRPS_Mixture</span></span>
<span><span class="co">#&gt; 11000:  Tatooine       500 2020-04-08 0.7719879 0.4106171 CRPS_Mixture</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="score-predictions">Score predictions<a class="anchor" aria-label="anchor" href="#score-predictions"></a>
</h4>
<p>Score predictions using the <code>scoringutils</code> package
(install from CRAN using
<code>install.packages("scoringutils")</code>).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combine data.frame with mixture with predictions from other models</span></span>
<span><span class="va">score_df</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">testdata</span>, <span class="va">test_mixture</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># CRPS score for all predictions using scoringutils</span></span>
<span><span class="va">score_df</span><span class="op">[</span>, <span class="va">crps</span> <span class="op">:=</span> <span class="fu">scoringutils</span><span class="fu">::</span><span class="fu">crps</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">observed</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">predicted</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">geography</span>, <span class="va">model</span>, <span class="va">date</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># summarise scores</span></span>
<span><span class="va">score_df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">crps</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">model</span><span class="op">]</span><span class="op">[</span>, <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="st">"V1"</span>, <span class="st">"CRPS"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Display other metrics</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span></span>
<span>  <span class="va">score_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"observed"</span>, <span class="st">"sample_id"</span>, <span class="st">"predicted"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"true_values"</span>, <span class="st">"sample"</span>, <span class="st">"predictions"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">scoringutils</span><span class="fu">::</span><span class="fu">eval_forecasts</span><span class="op">(</span><span class="va">score_df</span><span class="op">[</span><span class="va">geography</span> <span class="op">==</span> <span class="st">"Tatooine"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">scoringutils</span><span class="fu">::</span><span class="fu">eval_forecasts</span><span class="op">(</span><span class="va">score_df</span><span class="op">[</span><span class="va">geography</span> <span class="op">==</span> <span class="st">"Coruscant"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a>
</h2>
<p>Given a cumulative distribution function (CDF) with a finite first
moment of a probabilistic forecast, the corresponding Continuous Ranked
Probability Score can be written as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>r</mi><mi>p</mi><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>F</mi><mo>,</mo><mi>y</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>𝔼</mi><mi>X</mi></msub><mrow><mo stretchy="true" form="prefix">|</mo><mi>X</mi><mo>−</mo><mi>y</mi><mo stretchy="true" form="postfix">|</mo></mrow><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msub><mi>𝔼</mi><mrow><mi>X</mi><mo>,</mo><msup><mi>X</mi><mi>′</mi></msup></mrow></msub><mrow><mo stretchy="true" form="prefix">|</mo><mi>X</mi><mo>−</mo><msup><mi>X</mi><mi>′</mi></msup><mo stretchy="true" form="postfix">|</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">crps(F,y)=\mathbb{E}_X|X-y|- \frac{1}{2}\mathbb{E}_{X,X^\prime}|X-X^\prime|.\tag{1}</annotation></semantics></math></p>
<div class="section level3">
<h3 id="crps-for-one-model-and-one-single-observation">CRPS for one model and one single observation<a class="anchor" aria-label="anchor" href="#crps-for-one-model-and-one-single-observation"></a>
</h3>
<p>The CRPS can be used to stack different models to obtain one ensemble
mixture model. Let us assume we have data from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
time points
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>T</mi></mrow><annotation encoding="application/x-tex">t = 1, \dots, T</annotation></semantics></math>
in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
regions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">1, \dots, R</annotation></semantics></math>.
Observations are denoted
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mrow><mi>t</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">y_{tr}</annotation></semantics></math>.
Predictive samples are generated from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
different models
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>,</mo><mi>…</mi><mo>,</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">k, \dots, K</annotation></semantics></math>.
For every observation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mrow><mi>t</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">y_{tr}</annotation></semantics></math>
the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
predictive samples are denoted
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mn>1</mn><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>x</mi><mrow><mi>S</mi><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x_{1ktr}, \dots, x_{Sktr}</annotation></semantics></math>.</p>
<p>Using these predictive draws, we can compute the CRPS of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>-th
model for the observation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mrow><mi>t</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">y_{tr}</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
in region
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mrow><mi>c</mi><mi>r</mi><mi>p</mi><mi>s</mi></mrow><mo accent="true">̂</mo></mover><mrow><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo>=</mo><msub><mover><mrow><mi>c</mi><mi>r</mi><mi>p</mi><mi>s</mi></mrow><mo accent="true">̂</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><mn>1</mn><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>x</mi><mrow><mi>S</mi><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo>,</mo><msub><mi>y</mi><mrow><mi>t</mi><mi>r</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mi>S</mi></mfrac><munderover><mo>∑</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></munderover><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo>−</mo><msub><mi>y</mi><mrow><mi>t</mi><mi>r</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo>−</mo><mfrac><mn>1</mn><mrow><mn>2</mn><msup><mi>S</mi><mn>2</mn></msup></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>s</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></munderover><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo>−</mo><msub><mi>x</mi><mrow><mi>j</mi><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex"> \widehat {crps}_{ktr}= \widehat {crps}_(x_{1ktr}, \dots, x_{Sktr},y_{tr})= \frac{1}{S} \sum_{s=1}^S  |x_{sktr}-y_{tr}| -
\frac{1}{2S^2} \sum_{s, j=1}^S |x_{sktr}- x_{jktr}|. \tag{2}</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="crps-for-a-mixture-of-all-models-and-one-single-observation">CRPS for a mixture of all models and one single observation<a class="anchor" aria-label="anchor" href="#crps-for-a-mixture-of-all-models-and-one-single-observation"></a>
</h3>
<p>Now we want to aggregate predictions from these
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
models. When the prediction is a mixture of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>
models with weights
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>w</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">w_1, \dots, w_s</annotation></semantics></math>,
the CRPS can be expressed as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mrow><mi>c</mi><mi>r</mi><mi>p</mi><mi>s</mi></mrow><mo accent="true">̂</mo></mover><mrow><mi>a</mi><mi>g</mi><mi>g</mi><mo>,</mo><mi>t</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>w</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>w</mi><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mi>S</mi></mfrac><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mi>w</mi><mi>k</mi></msub><munderover><mo>∑</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></munderover><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>k</mi><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo>−</mo><mfrac><mn>1</mn><mrow><mn>2</mn><msup><mi>S</mi><mn>2</mn></msup></mrow></mfrac><mrow><mo stretchy="true" form="prefix">(</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><munderover><mo>∑</mo><mrow><mi>k</mi><mo>,</mo><mi>k</mi><mi>′</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mi>w</mi><mi>k</mi></msub><msub><mi>w</mi><mrow><mi>k</mi><mi>′</mi></mrow></msub><munderover><mo>∑</mo><mrow><mi>s</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></munderover><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>k</mi><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>x</mi><mrow><mi>j</mi><mi>k</mi><mi>′</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex"> \widehat {crps}_{agg, tr} (w_1, \dots, w_K) = \frac{1}{S} \sum_{k=1}^K w_k  \sum_{s=1}^S |x_{skt}-y_t| -
\frac{1}{2S^2}  (\sum_{k=1}^K   \sum_{k, k'=1 }^K w_k w_{k'}   \sum_{s, j=1}^S |x_{skt}- x_{jk't}| ). \tag{3}</annotation></semantics></math></p>
<p>This expression is quadratic in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>w</mi><annotation encoding="application/x-tex">w</annotation></semantics></math>.
We only need to compute
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></msubsup><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>k</mi><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>y</mi><mrow><mi>t</mi><mi>r</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">\sum_{s=1}^S |x_{skt}-y_{tr}|</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>s</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></msubsup><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo>−</mo><msub><mi>x</mi><mrow><mi>j</mi><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">\sum_{s, j=1}^S |x_{sktr}- x_{jktr}|</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>s</mi><mo>,</mo><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></msubsup><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>x</mi><mrow><mi>s</mi><mi>k</mi><mi>t</mi><mi>r</mi></mrow></msub><mo>−</mo><msub><mi>x</mi><mrow><mi>j</mi><mi>k</mi><mi>′</mi><mi>t</mi><mi>r</mi></mrow></msub><mo stretchy="true" form="postfix">|</mo></mrow></mrow><annotation encoding="application/x-tex">\sum_{s, j=1}^S |x_{sktr}- x_{jk'tr}|</annotation></semantics></math>
for all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>,</mo><mi>k</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">k, k'</annotation></semantics></math>
pairs once and store them for all weight values in the optimization.</p>
</div>
<div class="section level3">
<h3 id="obtaining-the-weights-that-minimize-crps">Obtaining the weights that minimize CRPS<a class="anchor" aria-label="anchor" href="#obtaining-the-weights-that-minimize-crps"></a>
</h3>
<p>The CRPS for the mixture of all models for all observations can
simply obtained by summing up the individual results from equation 3
over all regions and time points. However, we can also weight
predictions from different time points and regions differently. This
makes sense for example if we have very little data in the beginning or
if current older observations are less characteristic of the current and
future dynamics. In this case we might want to downweight the early
phase in the final model evaluation. Similarly, we might want to give
more or less weight to certain regions. Mathematically we can introduce
a time-varying weight
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>λ</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">\lambda_1, \dots, \lambda_T</annotation></semantics></math>,
e.g. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>t</mi></msub><mo>=</mo><mn>2</mn><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mi>/</mi><mi>T</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\lambda_t = 2-(1-t/T)^2</annotation></semantics></math>
to penalize earler estimates. Likewise we can introduce a
region-specific weight
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>τ</mi><mi>r</mi></msub><annotation encoding="application/x-tex">\tau_r</annotation></semantics></math>.</p>
<p>To obtain the CRPS weights we finally solve a quadratic
optimization:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><munder><mo>min</mo><mrow><msub><mi>w</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>w</mi><mi>K</mi></msub></mrow></munder><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><mi>R</mi></munderover><msub><mi>λ</mi><mi>t</mi></msub><msub><mi>τ</mi><mi>r</mi></msub><msub><mover><mrow><mi>c</mi><mi>r</mi><mi>p</mi><mi>s</mi></mrow><mo accent="true">̂</mo></mover><mrow><mi>a</mi><mi>g</mi><mi>g</mi><mo>,</mo><mi>t</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>w</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mi>s</mi><mi>.</mi><mi>t</mi><mi>.</mi><mspace width="0.222em"></mspace><mrow><mn>0</mn><mo>≤</mo><msub><mi>w</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>w</mi><mi>K</mi></msub><mo>≤</mo><mn>1</mn><mo>,</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mi>w</mi><mi>k</mi></msub><mo>=</mo><mn>1</mn></mrow><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
 &amp;\min_{w_1, \dots, w_K} \sum_{t=1}^T  \sum_{r=1}^R\lambda_t\tau_r  \widehat {crps}_{agg, tr} (w), \\
  &amp;s.t. ~{0\leq w_1, \dots, w_K \leq 1, \sum_{k=1}^K w_k=1}. 
\end{align*}</annotation></semantics></math></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Using Stacking to Average Bayesian Predictive Distributions, Yuling
Yao, Aki Vehtari, Daniel Simpson, and Andrew Gelman, 2018, Bayesian
Analysis 13, Number 3, pp. 917–1003 <a href="doi:10.1214/17-BA1091" class="uri">doi:10.1214/17-BA1091</a>
</li>
<li>Strictly Proper Scoring Rules, Prediction,and Estimation, Tilmann
Gneiting and Adrian E. Raftery, 2007, Journal of the American
Statistical Association, Volume 102, 2007 - Issue 477 <a href="doi:10.1198/016214506000001437" class="uri">doi:10.1198/016214506000001437</a>
</li>
<li>Comparing Bayes Model Averaging and Stacking When Model
Approximation Error Cannot be Ignored, Bertrand Clarke, 2003, Journal of
Machine Learning Research 4</li>
<li>Bayesian Model Weighting: The Many Faces of Model Averaging, Marvin
Höge, Anneli Guthke and Wolfgang Nowak, 2020, Water, <a href="doi:10.3390/w12020309" class="uri">doi:10.3390/w12020309</a>
</li>
<li>Bayesian Stacking and Pseudo-BMA weights using the loo package, Aki
Vehtari and Jonah Gabry, 2019, <a href="https://mc-stan.org/loo/articles/loo2-weights.html" class="external-link uri">https://mc-stan.org/loo/articles/loo2-weights.html</a>
</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nikos Bosse, Yuling Yao, Sam Abbott, Sebastian Funk.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
